<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Titus Taskboard</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
  :root {
    --bg: #f2ede4;
    --surface: #e8e0d0;
    --surface2: #ddd5c2;
    --border: #c8bea8;
    --border2: #a89e88;
    --accent: #3a6644;
    --accent-light: #4e8a5c;
    --text: #2c2416;
    --text2: #5c5040;
    --text3: #9a8e78;
    --p0: #b03a2a;
    --p1: #a06020;
    --p2: #3a6644;
    --p0-bg: #f5ddd8;
    --p1-bg: #f5e8d0;
    --p2-bg: #d4e6d8;
    --done-bg: #e0d8c8;    --done-text: #9a8e78;
    --new-bg: #d8e8f0;     --new-text: #2a5870;
    --inprog-bg: #d4e6d8;  --inprog-text: #2a5535;
    --waiting-bg: #f0e4cc; --waiting-text: #7a5020;
    --sched-bg: #e8d8f0;   --sched-text: #5a3575;
    --font: 'Plus Jakarta Sans', sans-serif;
    --font2: 'Nunito', sans-serif;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
  body { background: var(--bg); color: var(--text); font-family: var(--font); }

  .board-wrap { width: 100%; height: 100vh; overflow: auto; }
  .board-inner { }

  .header{
    padding: 18px 24px;
    border-bottom: 2px solid var(--border);
    display:flex; align-items:center; gap:18px;
    background: var(--surface);
    position: sticky; top:0; left:0; z-index:100;
    box-shadow: 0 2px 16px rgba(60,40,10,0.07);
  }
  .header-logo{
    width:34px;height:34px;background:var(--accent);border-radius:8px;
    display:flex;align-items:center;justify-content:center;flex-shrink:0;
  }
  .header-logo svg{width:18px;height:18px;fill:#f2ede4;}
  .header-title{font-size:18px;font-weight:800;letter-spacing:-0.3px;color:var(--accent);}
  .header .tabs{display:flex;gap:4px;margin-left:12px;}
  .tab-btn{
    background:none;border:1.5px solid var(--border);color:var(--text2);
    font-size:12px;font-weight:600;padding:5px 15px;border-radius:20px;
    cursor:pointer;transition:all .15s;
  }
  .tab-btn.active{background:var(--accent);color:#f2ede4;border-color:var(--accent);}
  .tab-btn:hover:not(.active){border-color:var(--border2);background:var(--surface2);color:var(--text);}
  .archive-tab-btn{border-style:dashed !important;}

  .add-btn{
    position:fixed; right:24px; bottom:24px; z-index:1000;
    background:var(--accent); border:none; color:#f2ede4;
    font-size:14px; font-weight:700; padding:14px 24px; border-radius:28px;
    cursor:pointer; transition:background .15s, box-shadow .15s;
    display:flex; align-items:center; gap:8px;
    box-shadow:0 4px 20px rgba(58,102,68,0.35);
  }
  .add-btn:hover{background:var(--accent-light);box-shadow:0 6px 24px rgba(58,102,68,0.45);}

  .filters{
    padding:9px 24px;
    border-bottom:1px solid var(--border);
    display:flex; gap:7px; align-items:center; background:var(--bg);
    flex-wrap:wrap;
    position: sticky; top:70px; left:0; z-index:90;
  }
  .filter-label{font-size:10px;font-weight:700;color:var(--text3);letter-spacing:.8px;text-transform:uppercase;}
  .filter-chip{
    background:var(--surface); border:1.5px solid var(--border); color:var(--text2);
    font-size:11px;font-weight:600;padding:4px 12px;border-radius:20px;
    cursor:pointer;transition:all .12s;
  }
  .filter-chip:hover{background:var(--surface2);border-color:var(--border2);}
  .filter-chip.active{background:var(--accent);color:#f2ede4;border-color:var(--accent);}

  .sort-select-wrap{display:flex;align-items:center;gap:6px;}
  .sort-select{
    background:var(--surface); border:1.5px solid var(--border); color:var(--text2);
    font-size:11px;font-weight:600;padding:4px 28px 4px 12px;border-radius:20px;
    cursor:pointer; outline:none; appearance:none; -webkit-appearance:none;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='5' viewBox='0 0 8 5'%3E%3Cpath d='M0 0l4 5 4-5z' fill='%239a8e78'/%3E%3C/svg%3E");
    background-repeat:no-repeat;background-position:right 10px center;
    transition:all .12s;
  }
  .sort-select:hover{border-color:var(--border2);background-color:var(--surface2);}
  .sort-select:focus{border-color:var(--accent);}
  .sort-select.active-sort{background-color:#d4e6d8;border-color:var(--accent);color:var(--accent);}

  .divider{width:1px;height:18px;background:var(--border);display:inline-block;margin:0 3px;flex-shrink:0;}

  .search-input{
    background:var(--surface); border:1.5px solid var(--border); color:var(--text);
    font-size:12px; padding:5px 14px; border-radius:20px; outline:none;
    width:210px; transition:border-color .15s;
  }
  .search-input:focus{border-color:var(--accent);}
  .search-input::placeholder{color:var(--text3);font-weight:500;}

  .reset-btn{
    background:none;border:1.5px solid var(--border2);color:var(--text3);
    font-size:11px;font-weight:700;padding:4px 12px;border-radius:20px;
    cursor:pointer;transition:all .12s;white-space:nowrap;
  }
  .reset-btn:hover{background:var(--p0-bg);border-color:var(--p0);color:var(--p0);}

  .table-wrap{padding:20px 24px 96px;}
  table{border-collapse:collapse;width:100%;}
  .col-wrap{white-space:normal;word-break:break-word;}

  thead th{
    background:var(--surface); color:var(--text3);
    font-size:10px;font-weight:700;letter-spacing:.6px;text-transform:uppercase;
    padding:10px 14px;text-align:left;
    border-bottom:2px solid var(--border); border-right:1px solid var(--border);
    white-space:nowrap;
    position: sticky; top:108px; z-index:10;
  }
  thead th:last-child{border-right:none;}

  tbody tr{border-bottom:1px solid var(--border);transition:background .1s;}
  tbody tr:hover{background:var(--surface);}
  tbody td{
    padding:11px 14px;border-right:1px solid var(--border);
    vertical-align:top;font-size:13px;
  }
  tbody td:last-child{border-right:none;}

  .priority-sel{
    font-size:11px;font-weight:700;border:none;border-radius:20px;
    padding:4px 10px;cursor:pointer;outline:none;min-width:52px;
    appearance:none;-webkit-appearance:none;text-align:center;background-image:none !important;
  }
  .p0{background:var(--p0-bg);color:var(--p0);}
  .p1{background:var(--p1-bg);color:var(--p1);}
  .p2{background:var(--p2-bg);color:var(--p2);}
  .p-none{background:var(--surface2);color:var(--text3);}

  .status-sel{
    font-size:11px;font-weight:600;border:1.5px solid transparent;border-radius:20px;
    padding:4px 10px;cursor:pointer;outline:none;white-space:nowrap;
    appearance:none;-webkit-appearance:none;background-image:none !important;
  }
  .status-New{background:var(--new-bg);color:var(--new-text);border-color:#b8d8e8;}
  .status-InProgress{background:var(--inprog-bg);color:var(--inprog-text);border-color:#a8ccb0;}
  .status-Waiting{background:var(--waiting-bg);color:var(--waiting-text);border-color:#d8c0a0;}
  .status-Scheduled{background:var(--sched-bg);color:var(--sched-text);border-color:#c8b0d8;}
  .status-Done{background:var(--done-bg);color:var(--done-text);border-color:#c0b8a8;}

  .waiton-sel{
    background:var(--surface);border:1.5px solid var(--border);color:var(--text2);
    font-size:11px;font-weight:600;padding:4px 10px;border-radius:20px;
    cursor:pointer;outline:none;appearance:none;-webkit-appearance:none;background-image:none !important;
  }

  .date-input{
    background:none;border:none;color:var(--text2);
    font-family:var(--font2);font-size:11px;font-weight:500;width:108px;
    cursor:pointer;outline:none;padding:2px 0;
  }
  .date-input::-webkit-calendar-picker-indicator{opacity:.35;cursor:pointer;width:12px;}
  .date-input:focus{color:var(--text);}
  .date-cell{min-width:100px;}

  .text-edit{
    background:none;border:none;border-bottom:1.5px dashed transparent;color:var(--text);
    font-size:13px;font-weight:500;width:100%;outline:none;padding:2px 0;
    transition:border-color .15s;line-height:1.5;
  }
  .text-edit:focus{border-bottom-color:var(--border2);}
  .text-edit::placeholder{color:var(--text3);font-weight:400;}

  .expand-textarea,.notes-textarea{
    background:none;border:none;border-bottom:1.5px dashed transparent;outline:none;
    overflow:hidden;resize:none;line-height:1.55;padding:2px 0;display:block;
    transition:border-color .15s;
  }
  .expand-textarea{color:var(--text);font-size:13px;font-weight:500;width:100%;}
  .notes-textarea{color:var(--text2);font-family:var(--font2);font-size:12px;font-weight:500;width:180px;min-width:180px;}
  .expand-textarea:focus,.notes-textarea:focus{border-bottom-color:var(--border2);}
  .expand-textarea::placeholder,.notes-textarea::placeholder{color:var(--text3);font-weight:400;}

  .account-text{font-weight:700;}

  .del-btn{
    background:none;border:none;color:var(--text3);cursor:pointer;
    font-size:17px;padding:0 4px;transition:color .15s;line-height:1;
  }
  .del-btn:hover{color:var(--p0);}

  .archived-row{opacity:.85;}
  .archived-row:hover{background:var(--surface);}

  .priority-badge{
    display:inline-block;font-size:11px;font-weight:700;border-radius:20px;padding:3px 10px;
  }
  .tab-badge{
    font-size:10px;font-weight:700;color:var(--text3);background:var(--surface2);
    border-radius:10px;padding:2px 8px;
  }
  .restore-btn{
    background:var(--p2-bg);border:1.5px solid var(--p2);color:var(--p2);
    font-size:11px;font-weight:700;padding:4px 10px;border-radius:20px;
    cursor:pointer;transition:opacity .15s;white-space:nowrap;
  }
  .restore-btn:hover{opacity:.75;}

  .empty-state{
    text-align:center;padding:60px 32px;color:var(--text3);font-size:13px;font-weight:500;
  }

  .sync-pill{
    margin-left:auto;
    font-size:11px;
    font-weight:700;
    padding:6px 10px;
    border-radius:999px;
    border:1.5px solid var(--border);
    background: rgba(255,255,255,0.25);
    color: var(--text2);
    white-space:nowrap;
  }
  .sync-ok{border-color:#a8ccb0;color:var(--accent);background:var(--p2-bg);}
  .sync-bad{border-color:#d8c0a0;color:#7a5020;background:var(--waiting-bg);}

  ::-webkit-scrollbar{width:6px;height:6px;}
  ::-webkit-scrollbar-track{background:var(--bg);}
  ::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
</style>
</head>
<body>

<div class="board-wrap"><div class="board-inner">

  <div class="header">
    <div class="header-logo">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
      </svg>
    </div>
    <span class="header-title">Titus Tasks</span>
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('external')">External</button>
      <button class="tab-btn" onclick="switchTab('internal')">Internal</button>
      <button class="tab-btn archive-tab-btn" onclick="switchTab('archive')">Archive</button>
    </div>

    <div id="sync-pill" class="sync-pill">Sync: loadingâ€¦</div>
  </div>

  <div class="filters">
    <input class="search-input" type="text" id="search-input" placeholder="ðŸ”  Search tasksâ€¦" oninput="handleSearch(this.value)" />
    <button class="reset-btn" onclick="resetFilters()">âœ• Reset</button>

    <span class="divider"></span>

    <span class="filter-label">Priority</span>
    <button class="filter-chip active" onclick="setFilter('all', this)">All</button>
    <button class="filter-chip" onclick="setFilter('P0', this)">P0</button>
    <button class="filter-chip" onclick="setFilter('P1', this)">P1</button>
    <button class="filter-chip" onclick="setFilter('P2', this)">P2</button>

    <span class="divider"></span>

    <span class="filter-label">Status</span>
    <button class="filter-chip" onclick="setStatusFilter('New', this)">New</button>
    <button class="filter-chip" onclick="setStatusFilter('In Progress', this)">In Progress</button>
    <button class="filter-chip" onclick="setStatusFilter('Waiting', this)">Waiting</button>
    <button class="filter-chip" onclick="setStatusFilter('Done', this)">Done</button>

    <span class="divider"></span>

    <span class="filter-label">Sort</span>
    <div class="sort-select-wrap">
      <select class="sort-select" id="sort-select" onchange="handleSortChange(this.value)">
        <option value="priority">By Priority</option>
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
      </select>
    </div>
  </div>

  <div class="table-wrap">
    <div id="board-container"></div>
  </div>

</div></div>

<button class="add-btn" onclick="addRow()">
  <span style="font-size:18px;line-height:1">+</span> Add Task
</button>

<script>
/**
 * ================================
 *  APPS SCRIPT SYNC CONFIG
 * ================================
 * This MUST be your deployed web-app URL that responds to:
 *   GET  ?action=load   -> returns JSON { externalData, internalData, externalArchive, internalArchive }
 *   POST {action:"save", ...same payload...} -> returns JSON { ok:true }
 */
const API_BASE = "https://script.google.com/macros/s/AKfycbzRdRDuzm-FlrCXSQ4wK1la0cSnuztwBb9OJY2xhQ-Xs1BlFo9cWWjzUOakMeizwnS3YQ/exec";

const LOCAL_KEY = "titus_taskboard_state_v1";

/** UI sync pill */
function setSync(status, text) {
  const pill = document.getElementById("sync-pill");
  if (!pill) return;
  pill.classList.remove("sync-ok","sync-bad");
  if (status === "ok") pill.classList.add("sync-ok");
  if (status === "bad") pill.classList.add("sync-bad");
  pill.textContent = text;
}

function safeJsonParse(s) { try { return JSON.parse(s); } catch { return null; } }

// â”€â”€â”€ DATA (will be overwritten by load) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const externalData = [];
const internalData = [];
const externalArchive = [];
const internalArchive = [];

let currentTab     = 'external';
let filterPriority = 'all';
let filterStatus   = 'all';
let searchQuery    = '';
let sortMode       = 'priority'; // 'priority' | 'newest' | 'oldest'
let nextId         = 100;

// â”€â”€â”€ SYNC: LOAD / SAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getState() {
  return { externalData, internalData, externalArchive, internalArchive, nextId };
}

function applyState(state) {
  // Clear & refill arrays in-place (so references remain valid)
  function refill(target, src) {
    target.length = 0;
    (src || []).forEach(x => target.push(x));
  }
  refill(externalData, state.externalData);
  refill(internalData, state.internalData);
  refill(externalArchive, state.externalArchive);
  refill(internalArchive, state.internalArchive);
  nextId = Number(state.nextId || nextId || 100);

  // Ensure IDs remain unique if someone pasted rows without nextId updated
  const all = [...externalData, ...internalData, ...externalArchive, ...internalArchive];
  const maxId = all.reduce((m, r) => Math.max(m, Number(r.id || 0)), 0);
  if (maxId >= nextId) nextId = maxId + 1;
}

async function apiLoad() {
  setSync("", "Sync: loadingâ€¦");
  // 1) Try server
  try {
    const res = await fetch(API_BASE + "&action=load", { method: "GET" });
    const txt = await res.text();
    const data = safeJsonParse(txt);
    if (!res.ok || !data) throw new Error("Bad response");
    applyState(data);
    localStorage.setItem(LOCAL_KEY, JSON.stringify(getState()));
    setSync("ok", "Sync: live");
    return;
  } catch (e) {
    // 2) Fallback to localStorage
    const cached = safeJsonParse(localStorage.getItem(LOCAL_KEY) || "");
    if (cached) {
      applyState(cached);
      setSync("bad", "Sync: offline (cached)");
      return;
    }
    setSync("bad", "Sync: offline");
  }
}

let saveTimer = null;
let savingNow = false;

function scheduleSave() {
  // debounce saves so typing doesnâ€™t spam the server
  clearTimeout(saveTimer);
  saveTimer = setTimeout(apiSave, 700);
}

async function apiSave() {
  if (savingNow) return;
  savingNow = true;
  setSync("", "Sync: savingâ€¦");
  const payload = { action: "save", ...getState() };

  // Always update local cache first
  localStorage.setItem(LOCAL_KEY, JSON.stringify(getState()));

  try {
    const res = await fetch(API_BASE, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    const txt = await res.text();
    const data = safeJsonParse(txt);
    if (!res.ok || !data || data.ok !== true) throw new Error("Save failed");
    setSync("ok", "Sync: saved");
  } catch (e) {
    setSync("bad", "Sync: offline (saved locally)");
  } finally {
    savingNow = false;
  }
}

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getData()    { return currentTab === 'external' ? externalData : internalData; }
function parseDate(s) {
  if (!s) return 0;
  const iso = s.includes('-') ? s : (() => {
    const p = s.split('/');
    return p.length === 3 ? `${p[2]}-${p[0].padStart(2,'0')}-${p[1].padStart(2,'0')}` : '';
  })();
  const d = new Date(iso);
  return isNaN(d) ? 0 : d.getTime();
}
function statusClass(s)   { return 'status-'+String(s||'').replace(/\s+/g,''); }
function priorityClass(p) { return p ? p.toLowerCase() : 'p-none'; }

function dateVal(s) {
  if (!s) return '';
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  const p = String(s).split('/');
  if (p.length===3) return `${p[2]}-${p[0].padStart(2,'0')}-${p[1].padStart(2,'0')}`;
  return '';
}
function formatDate(s) {
  if (!s) return '';
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
    const [y,m,d] = s.split('-');
    return `${+m}/${+d}/${y}`;
  }
  return s;
}
function esc(s) {
  return String(s||'')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function autoExpand(el) { el.style.height='auto'; el.style.height=el.scrollHeight+'px'; }
function autoExpandAll() {
  document.querySelectorAll('.expand-textarea,.notes-textarea').forEach(el => {
    el.style.height='auto'; el.style.height=el.scrollHeight+'px';
  });
}

// â”€â”€â”€ FILTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getFiltered() {
  let rows = getData().filter(r => {
    if (filterPriority !== 'all' && r.priority !== filterPriority) return false;
    if (filterStatus   !== 'all' && r.status   !== filterStatus)   return false;
    if (searchQuery) {
      const q = searchQuery.toLowerCase();
      const hay = [
        r.issue, r.account, r.category, r.notes, r.nextAction
      ].map(x => String(x||'').toLowerCase()).join(' | ');
      if (!hay.includes(q)) return false;
    }
    return true;
  });
  return rows;
}

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  const idx = tab === 'external' ? 0 : tab === 'internal' ? 1 : 2;
  document.querySelectorAll('.tab-btn')[idx].classList.add('active');
  document.querySelector('.filters').style.display = tab === 'archive' ? 'none' : '';
  document.querySelector('.add-btn').style.display  = tab === 'archive' ? 'none' : '';
  render();
}

function setFilter(val, el) {
  filterPriority = val;
  document.querySelectorAll('.filter-chip').forEach(c => {
    if (['All','P0','P1','P2'].includes(c.textContent.trim())) c.classList.remove('active');
  });
  el.classList.add('active');
  render();
}

function setStatusFilter(val, el) {
  filterStatus = filterStatus === val ? 'all' : val;
  document.querySelectorAll('.filter-chip').forEach(c => {
    if (['New','In Progress','Waiting','Done'].includes(c.textContent.trim())) c.classList.remove('active');
  });
  if (filterStatus !== 'all') el.classList.add('active');
  render();
}

function handleSearch(val) { searchQuery = val; render(); }

function resetFilters() {
  filterPriority = 'all';
  filterStatus   = 'all';
  searchQuery    = '';
  sortMode       = 'priority';
  document.getElementById('search-input').value = '';
  document.getElementById('sort-select').value  = 'priority';
  document.getElementById('sort-select').classList.remove('active-sort');
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.filter-chip')[0].classList.add('active');
  render();
}

function handleSortChange(val) {
  sortMode = val;
  const sel = document.getElementById('sort-select');
  sel.classList.toggle('active-sort', val !== 'priority');
  render();
}

// â”€â”€â”€ CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addRow() {
  const t = new Date();
  const dc = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
  getData().unshift({
    id: nextId++,
    priority:'', account:'', category:'',
    dateCreated: dc,
    issue:'New Task',
    status:'New',
    waitingOn:'Nobody',
    retailerSent:'', techSent:'', vendorSent:'',
    nextAction:'', notes:''
  });
  scheduleSave();
  render();
}

function archiveRow(id) {
  const data = getData();
  const idx = data.findIndex(r => Number(r.id) === Number(id));
  if (idx === -1) return;
  const [row] = data.splice(idx, 1);
  row._sourceTab = currentTab;
  (currentTab === 'external' ? externalArchive : internalArchive).unshift(row);
  scheduleSave();
  render();
}

function restoreRow(id) {
  for (const arr of [externalArchive, internalArchive]) {
    const idx = arr.findIndex(r => Number(r.id) === Number(id));
    if (idx !== -1) {
      const [row] = arr.splice(idx, 1);
      const target = row._sourceTab === 'internal' ? internalData : externalData;
      target.unshift(row);
      scheduleSave();
      render();
      return;
    }
  }
}

function updateField(id, field, value) {
  const row = getData().find(r => Number(r.id) === Number(id));
  if (!row) return;
  row[field] = value;
  scheduleSave();
  // re-render only when needed
  if (field === 'priority' || field === 'status') render();
}

// â”€â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStickyTop() {
  const header  = document.querySelector('.header');
  const filters = document.querySelector('.filters');
  if (!header || !filters) return;
  const headerH  = header.offsetHeight;
  filters.style.top = headerH + 'px';
  const filtersH = filters.offsetHeight;
  const theadTop = headerH + filtersH;
  document.querySelectorAll('thead th').forEach(th => th.style.top = theadTop + 'px');
}

function renderRow(r) {
  const pClass = priorityClass(r.priority);
  const sClass = statusClass(r.status);
  const isExt  = currentTab === 'external';
  return `
  <tr data-id="${r.id}">
    <td>
      <select class="priority-sel ${pClass}" onchange="updateField(${r.id},'priority',this.value)">
        <option value="" ${!r.priority?'selected':''}>â€”</option>
        <option ${r.priority==='P0'?'selected':''}>P0</option>
        <option ${r.priority==='P1'?'selected':''}>P1</option>
        <option ${r.priority==='P2'?'selected':''}>P2</option>
      </select>
    </td>
    ${isExt ? `<td class="col-wrap"><input class="text-edit account-text" value="${esc(r.account)}" placeholder="Account" onchange="updateField(${r.id},'account',this.value)" /></td>` : ''}
    <td class="col-wrap"><input class="text-edit" style="font-size:12px;color:var(--text2);" value="${esc(r.category)}" placeholder="Category" onchange="updateField(${r.id},'category',this.value)" /></td>
    <td>
      <select class="status-sel ${sClass}" onchange="updateField(${r.id},'status',this.value)">
        <option ${r.status==='New'?'selected':''}>New</option>
        <option ${r.status==='In Progress'?'selected':''}>In Progress</option>
        <option ${r.status==='Waiting'?'selected':''}>Waiting</option>
        <option ${r.status==='Scheduled'?'selected':''}>Scheduled</option>
        <option ${r.status==='Done'?'selected':''}>Done</option>
      </select>
    </td>
    <td>
      <select class="waiton-sel" onchange="updateField(${r.id},'waitingOn',this.value)">
        <option ${r.waitingOn==='Retailer'?'selected':''}>Retailer</option>
        <option ${r.waitingOn==='Tech'?'selected':''}>Tech</option>
        <option ${r.waitingOn==='Vendor'?'selected':''}>Vendor</option>
        <option ${r.waitingOn==='Me'?'selected':''}>Me</option>
        <option ${r.waitingOn==='Nobody'?'selected':''}>Nobody</option>
      </select>
    </td>
    <td class="col-wrap"><textarea class="expand-textarea" placeholder="Next actionâ€¦" oninput="autoExpand(this)" onchange="updateField(${r.id},'nextAction',this.value)">${esc(r.nextAction)}</textarea></td>
    <td class="date-cell"><input type="date" class="date-input" value="${dateVal(r.dateCreated)}" onchange="updateField(${r.id},'dateCreated',this.value)" /></td>
    <td class="date-cell"><input type="date" class="date-input" value="${dateVal(r.retailerSent)}" onchange="updateField(${r.id},'retailerSent',this.value)" /></td>
    <td class="date-cell"><input type="date" class="date-input" value="${dateVal(r.techSent)}" onchange="updateField(${r.id},'techSent',this.value)" /></td>
    <td class="date-cell"><input type="date" class="date-input" value="${dateVal(r.vendorSent)}" onchange="updateField(${r.id},'vendorSent',this.value)" /></td>
    <td class="col-wrap"><textarea class="notes-textarea" placeholder="Notesâ€¦" oninput="autoExpand(this)" onchange="updateField(${r.id},'notes',this.value)">${esc(r.notes)}</textarea></td>
    <td><button class="del-btn" onclick="archiveRow(${r.id})" title="Archive">â¤“</button></td>
  </tr>`;
}

function render() {
  const container = document.getElementById('board-container');

  if (currentTab === 'archive') {
    const archived = [...externalArchive, ...internalArchive];
    if (archived.length === 0) {
      container.innerHTML = `<div class="empty-state">Archive is empty.</div>`;
      requestAnimationFrame(setStickyTop);
      return;
    }

    let html = `<table><thead><tr>
      <th>Tab</th><th>Priority</th><th>Account</th><th>Category</th>
      <th>Status</th><th>Next Action</th><th>Date Created</th><th>Notes</th>
      <th>Restore</th>
    </tr></thead><tbody>`;

    for (const r of archived) {
      const pClass = priorityClass(r.priority);
      html += `<tr data-id="${r.id}" class="archived-row">
        <td><span class="tab-badge">${r._sourceTab === 'internal' ? 'Int' : 'Ext'}</span></td>
        <td>${r.priority ? `<span class="priority-badge ${pClass}">${esc(r.priority)}</span>` : '<span class="priority-badge p-none">â€”</span>'}</td>
        <td class="col-wrap">${esc(r.account||'')}</td>
        <td class="col-wrap">${esc(r.category||'')}</td>
        <td>${esc(r.status||'')}</td>
        <td class="col-wrap">${esc(r.nextAction||'')}</td>
        <td class="date-cell">${esc(formatDate(r.dateCreated))}</td>
        <td class="col-wrap">${esc(r.notes||'')}</td>
        <td><button class="restore-btn" onclick="restoreRow(${r.id})" title="Restore">â†© Restore</button></td>
      </tr>`;
    }
    html += `</tbody></table>`;
    container.innerHTML = html;
    requestAnimationFrame(setStickyTop);
    return;
  }

  const rows  = getFiltered();
  const isExt = currentTab === 'external';

  if (rows.length === 0) {
    container.innerHTML = `<div class="empty-state">No tasks match the current filters.</div>`;
    return;
  }

  let html = `<table><thead><tr>
    <th>Priority</th>
    ${isExt ? '<th>Account</th>' : ''}
    <th>Category</th>
    <th>Status</th>
    <th>Waiting On</th>
    <th>Next Action</th>
    <th>Date Created</th>
    <th>Retailer<br><span style="font-size:8px;opacity:.6;font-weight:500">Last Sent</span></th>
    <th>Tech<br><span style="font-size:8px;opacity:.6;font-weight:500">Last Sent</span></th>
    <th>Vendor<br><span style="font-size:8px;opacity:.6;font-weight:500">Last Sent</span></th>
    <th>Notes</th>
    <th></th>
  </tr></thead><tbody>`;

  const priOrder = { '': -1, P0:0, P1:1, P2:2 };
  const grouped = [...rows].sort((a,b) => {
    if (sortMode === 'newest') return parseDate(b.dateCreated) - parseDate(a.dateCreated);
    if (sortMode === 'oldest') return parseDate(a.dateCreated) - parseDate(b.dateCreated);
    return (priOrder[a.priority] ?? 3) - (priOrder[b.priority] ?? 3);
  });

  for (const r of grouped) html += renderRow(r);

  html += `</tbody></table>`;
  container.innerHTML = html;
  requestAnimationFrame(() => {
    autoExpandAll();
    setStickyTop();
  });
}

// â”€â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function init() {
  await apiLoad();
  render();
  setStickyTop();
})();

window.addEventListener('resize', setStickyTop);
</script>
</body>
</html>
